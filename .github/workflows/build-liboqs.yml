name: Build liboqs (Working)

on:
  workflow_dispatch:
    inputs:
      liboqs_version:
        description: 'liboqs version'
        required: true
        default: '0.15.0'

env:
  LIBOQS_REPO: 'open-quantum-safe/liboqs'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.LIBOQS_REPO }}
          ref: ${{ github.event.inputs.liboqs_version }}
      
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Build
        shell: cmd
        run: |
          choco install cmake ninja -y
          mkdir build && cd build
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DOQS_USE_OPENSSL=OFF -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX=install ..
          ninja install
          cd install
          tar -czf ..\liboqs-${{ github.event.inputs.liboqs_version }}-windows-x64.tar.gz *
      
      - uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: build/liboqs-*.tar.gz

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.LIBOQS_REPO }}
          ref: ${{ github.event.inputs.liboqs_version }}
      
      - name: Build
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build libssl-dev
          mkdir build && cd build
          cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DBUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX=install ..
          ninja install
          cd install
          tar -czf ../liboqs-${{ github.event.inputs.liboqs_version }}-linux-x64.tar.gz *
      
      - uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: build/liboqs-*.tar.gz

  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.LIBOQS_REPO }}
          ref: ${{ github.event.inputs.liboqs_version }}
      
      - name: Build
        run: |
          brew install cmake ninja openssl@3
          mkdir build && cd build
          cmake -GNinja -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON -DBUILD_TESTING=OFF -DOPENSSL_ROOT_DIR=$(brew --prefix openssl@3) -DCMAKE_INSTALL_PREFIX=install ..
          ninja install
          cd install
          tar -czf ../liboqs-${{ github.event.inputs.liboqs_version }}-macos-arm64.tar.gz *
      
      - uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: build/liboqs-*.tar.gz